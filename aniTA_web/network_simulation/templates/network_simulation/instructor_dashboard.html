{% extends 'network_simulation/base.html' %}

{% block title %}Instructor Analytics Dashboard{% endblock %}

{% block page_title %}Instructor Grading Analysis{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'network_simulation:index' %}">Network</a></li>
<li class="breadcrumb-item active" aria-current="page">Instructor Dashboard</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-fire me-2"></i> Mistake Heatmap
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    {% for class_code, course_data in heatmap.items %}
                    <button type="button" class="btn btn-outline-primary course-filter {% if forloop.first %}active{% endif %}" 
                            data-course="{{ class_code }}">
                        {{ class_code }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="card-body">
                {% if heatmap %}
                <div class="row">
                    <div class="col-md-8">
                        <div id="heatmapChart" style="height: 400px;"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="course-info mt-3">
                            {% for class_code, course_data in heatmap.items %}
                            <div class="course-details" data-course="{{ class_code }}" 
                                 {% if not forloop.first %}style="display: none;"{% endif %}>
                                <h5>{{ course_data.title }}</h5>
                                <p>
                                    <i class="fas fa-file-alt me-2"></i> 
                                    <strong>Submissions:</strong> {{ course_data.submission_count }}
                                </p>
                                <div class="criteria-summary mt-4">
                                    <h6>Top Problem Areas:</h6>
                                    <ul class="list-group">
                                        {% for criteria, stats in course_data.criteria_data.items|dictsort:"1.count"|slice:"-3:" %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ criteria }}
                                            <span class="badge bg-primary rounded-pill">
                                                {{ stats.percentage|floatformat:1 }}%
                                            </span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No heatmap data available yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-exclamation-triangle me-2"></i> Top Common Mistakes
            </div>
            <div class="card-body">
                {% if common_mistakes %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Issue</th>
                                <th>Frequency</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mistake in common_mistakes %}
                            <tr>
                                <td>{{ mistake.question|truncatechars:30 }}</td>
                                <td>{{ mistake.justification|truncatechars:50 }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ mistake.count|percentage_of:most_common_count }}%; background-color: var(--primary-color);" 
                                                 aria-valuenow="{{ mistake.count }}" aria-valuemin="0" aria-valuemax="{{ most_common_count }}">
                                            </div>
                                        </div>
                                        <span class="ms-2 text-muted">{{ mistake.count }}</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No common mistakes data available.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-balance-scale me-2"></i> Potential Grading Inconsistencies
            </div>
            <div class="card-body">
                {% if inconsistencies %}
                <div class="accordion" id="inconsistencyAccordion">
                    {% for item in inconsistencies %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ forloop.counter }}" 
                                    aria-expanded="false" 
                                    aria-controls="collapse{{ forloop.counter }}">
                                <div class="d-flex justify-content-between w-100">
                                    <div>{{ item.question|truncatechars:40 }}</div>
                                    <div class="badge bg-warning text-dark ms-2">
                                        {{ item.inconsistency.score_difference|floatformat:1 }} point difference
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                             aria-labelledby="heading{{ forloop.counter }}" 
                             data-bs-parent="#inconsistencyAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-2">
                                            <div class="card-header bg-light">
                                                <strong>Case 1:</strong> {{ item.inconsistency.case1.score }} points
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-0">{{ item.inconsistency.case1.justification }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <strong>Case 2:</strong> {{ item.inconsistency.case2.score }} points
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-0">{{ item.inconsistency.case2.justification }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i> No grading inconsistencies detected.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-project-diagram me-2"></i> Mistake Clusters Analysis
            </div>
            <div class="card-body">
                {% if mistake_clusters %}
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Cluster Statistics</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center mb-3">
                                            <div class="fs-4">{{ mistake_clusters.stats.total_mistakes }}</div>
                                            <div class="text-muted small">Total Mistakes</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center mb-3">
                                            <div class="fs-4">{{ mistake_clusters.stats.total_clusters }}</div>
                                            <div class="text-muted small">Clusters</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="fs-4">{{ mistake_clusters.stats.total_connections }}</div>
                                            <div class="text-muted small">Connections</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="fs-4">{{ mistake_clusters.stats.avg_cluster_size|floatformat:1 }}</div>
                                            <div class="text-muted small">Avg. Size</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="clusterBubbleChart" style="height: 350px;"></div>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3">Cluster Details</h5>
                <div class="accordion" id="clusterAccordion">
                    {% for cluster in mistake_clusters.clusters %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="clusterHeading{{ forloop.counter }}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#clusterCollapse{{ forloop.counter }}" 
                                    aria-expanded="false" 
                                    aria-controls="clusterCollapse{{ forloop.counter }}">
                                <div class="d-flex justify-content-between w-100 align-items-center">
                                    <div><strong>Cluster {{ forloop.counter }}</strong> ({{ cluster.size }} mistakes)</div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-light text-dark me-2">
                                            Avg score: {{ cluster.avg_score|floatformat:1 }}
                                        </span>
                                        {% for criteria in cluster.top_criteria %}
                                        <span class="badge bg-primary me-1">{{ criteria }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="clusterCollapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                             aria-labelledby="clusterHeading{{ forloop.counter }}" 
                             data-bs-parent="#clusterAccordion">
                            <div class="accordion-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Question</th>
                                            <th>Score</th>
                                            <th>Criteria</th>
                                            <th>Importance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in cluster.nodes %}
                                        <tr>
                                            <td>{{ node.label|truncatechars:50 }}</td>
                                            <td>{{ node.score }}</td>
                                            <td>
                                                {% for c in node.criteria %}
                                                <span class="badge bg-light text-primary">{{ c }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: {{ node.importance|multiply:100|floatformat:1 }}%; background-color: var(--primary-color);">
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No cluster data available yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if heatmap %}
        // Process heatmap data
        const heatmapData = {};
        const allCategories = new Set();
        
        {% for class_code, course_data in heatmap.items %}
        heatmapData["{{ class_code }}"] = {
            title: "{{ course_data.title }}",
            data: []
        };
        
        {% for criteria, stats in course_data.criteria_data.items %}
        heatmapData["{{ class_code }}"].data.push({
            criteria: "{{ criteria }}",
            percentage: {{ stats.percentage|floatformat:1 }},
            count: {{ stats.count }}
        });
        allCategories.add("{{ criteria }}");
        {% endfor %}
        {% endfor %}
        
        // Convert to array and sort by criteria name
        const categoriesArray = Array.from(allCategories).sort();
        
        // Initialize with first course
        let currentCourse = "{{ heatmap.keys|first }}";
        renderHeatmap(currentCourse);
        
        // Course filter buttons
        document.querySelectorAll('.course-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active class
                document.querySelectorAll('.course-filter').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Update visible course info
                document.querySelectorAll('.course-details').forEach(div => {
                    div.style.display = 'none';
                });
                const courseCode = this.dataset.course;
                document.querySelector(`.course-details[data-course="${courseCode}"]`).style.display = 'block';
                
                // Render heatmap for selected course
                renderHeatmap(courseCode);
            });
        });
        
        function renderHeatmap(courseCode) {
            const courseData = heatmapData[courseCode];
            if (!courseData) return;
            
            // Create a map for quick lookup
            const dataMap = {};
            courseData.data.forEach(item => {
                dataMap[item.criteria] = item.percentage;
            });
            
            // Create data array with all categories
            const seriesData = categoriesArray.map(criteria => {
                return {
                    x: criteria,
                    y: dataMap[criteria] || 0
                };
            }).sort((a, b) => b.y - a.y).slice(0, 10); // Top 10 by percentage
            
            // Extract categories and values for chart
            const chartCategories = seriesData.map(item => item.x);
            const chartValues = seriesData.map(item => item.y);
            
            // Destroy previous chart if exists
            if (window.heatmapChart) {
                window.heatmapChart.destroy();
            }
            
            // Create heatmap chart
            const options = {
                series: [{
                    name: 'Mistake Frequency',
                    data: chartValues
                }],
                chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        distributed: true,
                        barHeight: '80%',
                        dataLabels: {
                            position: 'bottom'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return val.toFixed(1) + '%';
                    },
                    offsetX: 10,
                    style: {
                        fontSize: '12px',
                        colors: ['#fff']
                    }
                },
                colors: [
                    function({ value }) {
                        if (value < 20) return '#a5d6a7';
                        else if (value < 40) return '#ffe082';
                        else if (value < 60) return '#ffab91';
                        else return '#ef9a9a';
                    }
                ],
                xaxis: {
                    categories: chartCategories,
                    labels: {
                        formatter: function(val) {
                            return val.toFixed(1) + '%';
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(val) {
                            // Truncate long criterion names
                            return val.length > 25 ? val.substr(0, 25) + '...' : val;
                        }
                    }
                },
                title: {
                    text: `Mistake Frequency for ${courseCode}`,
                    align: 'center',
                    style: {
                        fontSize: '14px'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val.toFixed(1) + '%';
                        }
                    }
                }
            };

            window.heatmapChart = new ApexCharts(document.querySelector("#heatmapChart"), options);
            window.heatmapChart.render();
        }
        {% endif %}
        
        {% if mistake_clusters %}
        // Cluster bubble chart
        const clusterData = [];
        
        {% for cluster in mistake_clusters.clusters %}
        clusterData.push({
            x: "Cluster {{ forloop.counter }}",
            y: {{ cluster.avg_score|floatformat:1 }},
            z: {{ cluster.size }},
            criteria: [{% for c in cluster.top_criteria %}"{{ c }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
        });
        {% endfor %}
        
        const bubbleOptions = {
            series: [{
                name: 'Clusters',
                data: clusterData
            }],
            chart: {
                height: 350,
                type: 'bubble',
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'vertical',
                    shadeIntensity: 0.5,
                    inverseColors: true,
                    opacityFrom: 1,
                    opacityTo: 0.8,
                    stops: [0, 100]
                }
            },
            title: {
                text: 'Mistake Clusters by Size and Score',
                align: 'center',
                style: {
                    fontSize: '14px'
                }
            },
            xaxis: {
                type: 'category',
                labels: {
                    formatter: function(val) {
                        return val;
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Average Score'
                },
                min: 0,
                max: 100
            },
            tooltip: {
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    const data = w.config.series[seriesIndex].data[dataPointIndex];
                    return `
                        <div class="p-2">
                            <div><strong>${data.x}</strong></div>
                            <div>Size: ${data.z} mistakes</div>
                            <div>Avg. Score: ${data.y}</div>
                            <div>Top Criteria: ${data.criteria.join(', ')}</div>
                        </div>
                    `;
                }
            }
        };

        const bubbleChart = new ApexCharts(document.querySelector("#clusterBubbleChart"), bubbleOptions);
        bubbleChart.render();
        {% endif %}
    });
</script>
{% endblock %}