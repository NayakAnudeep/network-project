{% extends 'network_simulation/base.html' %}
{% load network_tags %}

{% block title %}Instructor Analytics Dashboard{% endblock %}

{% block page_title %}Instructor Grading Analysis{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'network_simulation:index' %}">Network</a></li>
<li class="breadcrumb-item active" aria-current="page">Instructor Dashboard</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i> Rubric Performance Insights
            </div>
            <div class="card-body">
                {% if common_mistakes %}
                <div id="rubricPerformanceChart" style="height: 450px;"></div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No rubric performance data available yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-exclamation-triangle me-2"></i> Most Problematic Rubric Items
            </div>
            <div class="card-body">
                {% if common_mistakes %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rubric Item</th>
                                <th>Description</th>
                                <th>Connections</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rubric in common_mistakes %}
                            <tr>
                                <td><strong>{{ rubric.name|truncatechars:30 }}</strong></td>
                                <td>{{ rubric.description|truncatechars:50 }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ rubric.connections|percentage_of:most_common_count }}%; background-color: var(--primary-color);" 
                                                 aria-valuenow="{{ rubric.connections }}" aria-valuemin="0" aria-valuemax="{{ most_common_count }}">
                                            </div>
                                        </div>
                                        <span class="ms-2 text-muted">{{ rubric.connections }}</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No rubric data available.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-balance-scale me-2"></i> Potential Grading Inconsistencies
            </div>
            <div class="card-body">
                {% if inconsistencies %}
                <div class="accordion" id="inconsistencyAccordion">
                    {% for item in inconsistencies %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ forloop.counter }}" 
                                    aria-expanded="false" 
                                    aria-controls="collapse{{ forloop.counter }}">
                                <div class="d-flex justify-content-between w-100">
                                    <div>{{ item.question|truncatechars:40 }}</div>
                                    <div class="badge bg-warning text-dark ms-2">
                                        {{ item.inconsistency.score_difference|floatformat:2 }} point difference
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                             aria-labelledby="heading{{ forloop.counter }}" 
                             data-bs-parent="#inconsistencyAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-2">
                                            <div class="card-header bg-light">
                                                <strong>Case 1:</strong> {{ item.inconsistency.case1.score|floatformat:2 }} points
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-0">{{ item.inconsistency.case1.justification }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <strong>Case 2:</strong> {{ item.inconsistency.case2.score|floatformat:2 }} points
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-0">{{ item.inconsistency.case2.justification }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i> No grading inconsistencies detected.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-project-diagram me-2"></i> Rubric-Based Mistake Clusters
            </div>
            <div class="card-body">
                {% if mistake_clusters %}
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Cluster Statistics</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center mb-3">
                                            <div class="fs-4">{{ mistake_clusters.stats.total_mistakes }}</div>
                                            <div class="text-muted small">Total Mistakes</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center mb-3">
                                            <div class="fs-4">{{ mistake_clusters.stats.total_clusters }}</div>
                                            <div class="text-muted small">Rubric Clusters</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="text-center">
                                            <div class="fs-4">{{ mistake_clusters.stats.avg_cluster_size|floatformat:2 }}</div>
                                            <div class="text-muted small">Avg. Mistakes per Rubric</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="clusterBubbleChart" style="height: 350px;"></div>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3">Rubric Cluster Details</h5>
                <div class="accordion" id="clusterAccordion">
                    {% for cluster in mistake_clusters.clusters %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="clusterHeading{{ forloop.counter }}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#clusterCollapse{{ forloop.counter }}" 
                                    aria-expanded="false" 
                                    aria-controls="clusterCollapse{{ forloop.counter }}">
                                <div class="d-flex justify-content-between w-100 align-items-center">
                                    <div><strong>{{ cluster.name }}</strong> ({{ cluster.size }} mistakes)</div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-light text-dark me-2">
                                            Avg score: {{ cluster.avg_score|floatformat:2 }}
                                        </span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="clusterCollapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                             aria-labelledby="clusterHeading{{ forloop.counter }}" 
                             data-bs-parent="#clusterAccordion">
                            <div class="accordion-body">
                                <p class="mb-3">{{ cluster.description }}</p>
                                
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Assignment/Exam</th>
                                            <th>Score</th>
                                            <th width="40%">Feedback</th>
                                            <th>Importance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in cluster.nodes %}
                                        <tr>
                                            <td>{{ node.label|truncatechars:30 }}</td>
                                            <td>{{ node.score|floatformat:2 }}</td>
                                            <td><small>{{ node.justification|truncatechars:80 }}</small></td>
                                            <td>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: {{ node.importance|multiply:100|floatformat:2 }}%; background-color: var(--primary-color);">
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No cluster data available yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if common_mistakes %}
        // Process rubric data for the performance chart
        const rubricNames = [];
        const rubricScores = [];
        const rubricConnections = [];
        
        {% for rubric in common_mistakes %}
        rubricNames.push("{{ rubric.name|truncatechars:25|escapejs }}");
        rubricScores.push({{ rubric.degree|floatformat:2 }});  // Use degree as the score
        rubricConnections.push({{ rubric.connections|floatformat:0 }});
        {% endfor %}
        
        // Calculate problem scores (100 - inverted normalized score)
        const maxConnections = Math.max(...rubricConnections);
        const normalizedConnections = rubricConnections.map(c => {
            // Format to 2 decimal places
            return parseFloat(((c / maxConnections) * 100).toFixed(2));
        });
        
        // Create the performance chart
        const options = {
            series: [{
                name: 'Issue Frequency',
                type: 'column',
                data: rubricConnections
            }, {
                name: 'Problem Score',
                type: 'line',
                data: normalizedConnections
            }],
            chart: {
                height: 450,
                type: 'line',
                toolbar: {
                    show: false
                }
            },
            stroke: {
                width: [0, 4],
                curve: 'smooth'
            },
            plotOptions: {
                bar: {
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            colors: ['#6c757d', '#dc3545'],
            labels: rubricNames,
            xaxis: {
                type: 'category',
                labels: {
                    rotate: -45,
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yaxis: [{
                title: {
                    text: 'Issue Frequency',
                },
                min: 0
            }, {
                opposite: true,
                title: {
                    text: 'Problem Score'
                },
                min: 0,
                max: 100
            }],
            title: {
                text: 'Rubric Item Performance Analysis',
                align: 'center',
                style: {
                    fontSize: '16px'
                }
            },
            legend: {
                position: 'top'
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: [{
                    formatter: function(val) {
                        return val.toFixed(0) + " occurrences";
                    }
                }, {
                    formatter: function(val) {
                        return val.toFixed(2) + "% severity";
                    }
                }]
            }
        };

        const performanceChart = new ApexCharts(document.querySelector("#rubricPerformanceChart"), options);
        performanceChart.render();
        {% endif %}
        
        {% if mistake_clusters %}
        // Cluster bubble chart
        const clusterData = [];
        
        {% for cluster in mistake_clusters.clusters %}
        clusterData.push({
            x: "{{ cluster.name|escapejs }}",
            y: {{ cluster.avg_score|floatformat:2 }},
            z: {{ cluster.size }},
            description: "{{ cluster.description|escapejs }}"
        });
        {% endfor %}
        
        const bubbleOptions = {
            series: [{
                name: 'Rubric Clusters',
                data: clusterData
            }],
            chart: {
                height: 350,
                type: 'bubble',
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'vertical',
                    shadeIntensity: 0.5,
                    inverseColors: true,
                    opacityFrom: 1,
                    opacityTo: 0.8,
                    stops: [0, 100]
                }
            },
            title: {
                text: 'Rubric Clusters by Size and Score',
                align: 'center',
                style: {
                    fontSize: '14px'
                }
            },
            xaxis: {
                type: 'category',
                labels: {
                    formatter: function(val) {
                        return val.length > 15 ? val.substr(0, 15) + '...' : val;
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Average Score'
                },
                min: 0,
                max: 100
            },
            tooltip: {
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    const data = w.config.series[seriesIndex].data[dataPointIndex];
                    return `
                        <div class="p-2">
                            <div><strong>${data.x}</strong></div>
                            <div>Size: ${data.z} mistakes</div>
                            <div>Avg. Score: ${data.y}</div>
                            <div>Description: ${data.description}</div>
                        </div>
                    `;
                }
            }
        };

        const bubbleChart = new ApexCharts(document.querySelector("#clusterBubbleChart"), bubbleOptions);
        bubbleChart.render();
        {% endif %}
    });
</script>
{% endblock %}