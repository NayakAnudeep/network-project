{% extends 'network_simulation/base.html' %}

{% block title %}Course: {{ course.name }}{% endblock %}

{% block page_title %}Course Profile: {{ course.name }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'network_simulation:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'network_simulation:course_network' %}">Course Network</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ course.name }}</li>
{% endblock %}

{% block page_actions %}
<a href="{% url 'network_simulation:course_network' %}" class="btn btn-sm btn-outline-secondary me-2">
    <i class="fas fa-arrow-left"></i> Back to Courses
</a>
<div class="dropdown">
    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-download"></i> Export
    </button>
    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
        <li><a class="dropdown-item" href="#" id="exportSyllabus">Course Syllabus (PDF)</a></li>
        <li><a class="dropdown-item" href="#" id="exportRoster">Student Roster (CSV)</a></li>
        <li><a class="dropdown-item" href="#" id="exportGrades">Grade Distribution (CSV)</a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-book me-2"></i> Course Information
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ course.name }}</h4>
                <h6 class="card-subtitle mb-3 text-muted">ID: {{ course.id }}</h6>
                
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Credits:</span>
                        <strong>{{ course.credits }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Students:</span>
                        <strong>{{ enrollment_count }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Assessments:</span>
                        <strong>{{ assessment_count }}</strong>
                    </li>
                </ul>
                
                <div class="d-grid">
                    <button class="btn btn-outline-primary" disabled>
                        <i class="fas fa-book-open me-2"></i> View Course Materials
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i> Grade Distribution
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <canvas id="gradeDistributionChart" height="250"></canvas>
                    </div>
                    <div class="col-md-7">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Grade</th>
                                    <th>Range</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge bg-success">A</span></td>
                                    <td>90-100</td>
                                    <td>{{ grade_distribution.A }}</td>
                                    <td>{{ grade_distribution.A|default:0|divisor:enrollment_count|multiply:100 }}%</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-primary">B</span></td>
                                    <td>80-89</td>
                                    <td>{{ grade_distribution.B }}</td>
                                    <td>{{ grade_distribution.B|default:0|divisor:enrollment_count|multiply:100 }}%</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-warning">C</span></td>
                                    <td>70-79</td>
                                    <td>{{ grade_distribution.C }}</td>
                                    <td>{{ grade_distribution.C|default:0|divisor:enrollment_count|multiply:100 }}%</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-danger">D</span></td>
                                    <td>60-69</td>
                                    <td>{{ grade_distribution.D }}</td>
                                    <td>{{ grade_distribution.D|default:0|divisor:enrollment_count|multiply:100 }}%</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-secondary">F</span></td>
                                    <td>0-59</td>
                                    <td>{{ grade_distribution.F }}</td>
                                    <td>{{ grade_distribution.F|default:0|divisor:enrollment_count|multiply:100 }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chalkboard-teacher me-2"></i> Instructors
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Instructor</th>
                                <th>Specialization</th>
                                <th>Assessments</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instructor in instructors %}
                            <tr>
                                <td>
                                    <a href="{% url 'network_simulation:instructor_detail' instructor_id=instructor.id %}">
                                        {{ instructor.name }}
                                    </a>
                                </td>
                                <td>{{ instructor.specialization }}</td>
                                <td>{{ instructor.assessment_count }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No instructor data available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tasks me-2"></i> Assessment Statistics
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Count</th>
                                <th>Average</th>
                                <th>Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in assessment_stats %}
                            <tr>
                                <td>{{ stat.type }}</td>
                                <td>{{ stat.count }}</td>
                                <td>{{ stat.avg_score }}</td>
                                <td>{{ stat.min_score }} - {{ stat.max_score }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No assessment data available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <canvas id="assessmentTypeChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-user-graduate me-2"></i> Enrolled Students</span>
                <select class="form-select form-select-sm" style="width: auto;" id="studentFilter">
                    <option value="all">All Students</option>
                    <option value="top">Top Performers</option>
                    <option value="struggling">Struggling Students</option>
                </select>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Year</th>
                                <th>GPA</th>
                                <th>Final Grade</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>
                                    <a href="{% url 'network_simulation:student_detail' student_id=student.id %}">
                                        {{ student.name }}
                                    </a>
                                </td>
                                <td>{{ student.year }}</td>
                                <td>{{ student.gpa }}</td>
                                <td>{{ student.final_grade|floatformat:1 }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar 
                                            {% if student.final_grade >= 90 %}bg-success
                                            {% elif student.final_grade >= 80 %}bg-primary
                                            {% elif student.final_grade >= 70 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ student.final_grade }}%;" 
                                            aria-valuenow="{{ student.final_grade }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                            {{ student.final_grade|floatformat:1 }}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No student data available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Export buttons functionality
        document.getElementById('exportSyllabus').addEventListener('click', function() {
            alert('This feature would export the course syllabus as a PDF.');
        });
        
        document.getElementById('exportRoster').addEventListener('click', function() {
            alert('This feature would export the student roster as a CSV file.');
        });
        
        document.getElementById('exportGrades').addEventListener('click', function() {
            alert('This feature would export the grade distribution as a CSV file.');
        });
        
        // Student filter functionality
        document.getElementById('studentFilter').addEventListener('change', function() {
            // This would filter the students table by the selected option
            // For now, just show a placeholder message
            alert('This would filter students by ' + this.options[this.selectedIndex].text);
        });
        
        // Create charts
        createGradeDistributionChart();
        createAssessmentTypeChart();
    });
    
    function createGradeDistributionChart() {
        const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
        
        // Get grade distribution data
        const gradeDistribution = {{ grade_distribution|safe|default:"{'A': 0, 'B': 0, 'C': 0, 'D': 0, 'F': 0}" }};
        
        // Create chart
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['A', 'B', 'C', 'D', 'F'],
                datasets: [{
                    data: [
                        gradeDistribution.A || 0,
                        gradeDistribution.B || 0,
                        gradeDistribution.C || 0,
                        gradeDistribution.D || 0,
                        gradeDistribution.F || 0
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',  // success (green)
                        'rgba(0, 123, 255, 0.7)',  // primary (blue)
                        'rgba(255, 193, 7, 0.7)',  // warning (yellow)
                        'rgba(220, 53, 69, 0.7)',  // danger (red)
                        'rgba(108, 117, 125, 0.7)' // secondary (gray)
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(0, 123, 255, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)',
                        'rgba(108, 117, 125, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Grade Distribution'
                    }
                }
            }
        });
    }
    
    function createAssessmentTypeChart() {
        const ctx = document.getElementById('assessmentTypeChart').getContext('2d');
        
        // Get assessment stats data
        const assessmentStats = {{ assessment_stats|safe|default:"[]" }};
        
        // Extract data for chart
        const types = assessmentStats.map(stat => stat.type);
        const counts = assessmentStats.map(stat => stat.count);
        const avgScores = assessmentStats.map(stat => stat.avg_score);
        
        // Create chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: types,
                datasets: [
                    {
                        label: 'Count',
                        data: counts,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Average Score',
                        data: avgScores,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        type: 'line'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Count'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        max: 100,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Average Score'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Assessment Types Analysis'
                    }
                }
            }
        });
    }
</script>
{% endblock %}
