<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>File Upload</title>
        {% load static %}
    </head>
    <style>
     form {
         max-width: 400px;
         margin: 20px auto;
         padding: 15px;
         border-radius: 8px;
         background-color: #f8f9fa;
         box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
         display: flex;
         flex-direction: column;
     }

     .file-input {
         margin-bottom: 12px;
         padding: 8px;
         border: 1px solid #ced4da;
         border-radius: 4px;
         background-color: white;
     }

     .upload-button {
         background-color: #4a6fff;
         color: white;
         border: none;
         border-radius: 4px;
         padding: 10px 16px;
         cursor: pointer;
         font-weight: 500;
         transition: background-color 0.2s;
     }

     .upload-button:hover {
         background-color: #3255db;
     }

     .upload-button:disabled {
         background-color: #b4b4b4;
         cursor: not-allowed;
     }
     
     .alert {
         padding: 12px 15px;
         margin-bottom: 15px;
         border-radius: 5px;
         font-weight: 500;
     }
     
     .alert-success {
         background-color: #ecfdf5;
         color: #047857;
         border-left: 4px solid #047857;
     }
     
     .alert-error {
         background-color: #fef2f2;
         color: #b91c1c;
         border-left: 4px solid #b91c1c;
     }
    </style>
    <body>
        {% if flash_success %}
            {% for message in flash_success %}
            <div class="alert alert-success">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
        
        {% if flash_error %}
            {% for message in flash_error %}
            <div class="alert alert-error">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
        
        <div class="Instructions">
            <h3>Instructions</h3>
            <iframe src="{% url 'view_assignment_instructions' assignment_id=assignment_id %}" width="100%" height="500px"></iframe>
        </div>

        {% if has_previous_submission %}
        <div class="previous-submission">
            <h3>{% if submission_id %}Submitted: {{ file_name }}{% else %}Previously Submitted{% endif %}</h3>
            <iframe src="{% url 'view_pdf' submission_id=submission_id %}" width="100%" height="500px"></iframe>
        </div>
        
        <!-- Always show grading results if AI has graded the submission -->
        <!-- Graded flag is: {{ graded|yesno:"true,false,unset" }} -->
        {% if graded %}
        <div class="grading-info" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="color: #2c5282; margin-bottom: 12px;">AI Grading Results</h4>
            <p><strong>Grade:</strong> <span style="font-size: 1.1em; font-weight: bold; color: #2c5282;">{{ grade|floatformat:2 }}</span></p>
            <hr style="border: 0; height: 1px; background: #d0def0; margin: 10px 0;">
            <p><strong>Feedback:</strong></p>
            <pre style="white-space: pre-wrap; font-family: Arial, sans-serif; background: #f8fafc; padding: 10px; border-radius: 4px; border-left: 3px solid #4a6fff;">{{ feedback }}</pre>
        </div>
        {% else %}
        <!-- Debugging info -->
        <div style="margin-top: 20px; padding: 15px; border: 2px solid #f00; background: #fff9f9; font-size: 14px; color: #333;">
            <h3 style="color: #f00; margin-top: 0;">DEBUG: Graded flag is False or not set</h3>
            <p><strong>Context variables available:</strong></p>
            <ul style="margin-bottom: 10px;">
                <li><strong>has_previous_submission:</strong> {{ has_previous_submission }}</li>
                <li><strong>submission_id:</strong> {{ submission_id }}</li>
                <li><strong>grade:</strong> {{ grade }}</li>
                <li><strong>feedback length:</strong> {% if feedback %}{{ feedback|length }}{% else %}0{% endif %}</li>
                <li><strong>graded:</strong> {{ graded }}</li>
                <li><strong>class_code:</strong> {{ class_code }}</li>
                <li><strong>assignment_id:</strong> {{ assignment_id }}</li>
            </ul>
            <div style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">
                <p><strong>Feedback content (if available):</strong></p>
                <pre style="background: #f5f5f5; padding: 10px; overflow: auto; max-height: 200px; font-size: 12px;">{% if feedback %}{{ feedback }}{% else %}No feedback available{% endif %}</pre>
            </div>
        </div>
        {% endif %}
        {% else %}
        <form action="{% url 'upload_assignment' class_code=class_code assignment_id=assignment_id %}" method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            <div>
                <label for="file_input">File</label>
                <input type="file" id="file_input" name="file_input" class="file-input", accept=".pdf">
                <small>Supported formats: PDF</small>
            </div>
            <button type="submit" class="upload-button" id="uploadBtn">Upload</button>
            <div id="loadingIndicator" style="display: none; margin-top: 15px; text-align: center;">
                <div style="display: inline-block; width: 24px; height: 24px; border: 3px solid #4a6fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 10px; color: #4a6fff;">Uploading and generating AI feedback...</p>
            </div>
        </form>
        
        <style>
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
        
        <script>
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                if (document.getElementById('file_input').files.length > 0) {
                    document.getElementById('uploadBtn').disabled = true;
                    document.getElementById('loadingIndicator').style.display = 'block';
                }
            });
        </script>
        {% endif %}
    </body>
</html>
